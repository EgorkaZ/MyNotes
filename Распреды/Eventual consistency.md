# Eventual consistency
Если в системе нет сбоев, то через какое-то время все узлы системы придут к [[Консенсус|консенсусу]]. Нужны для [[CAP теорема#Availability|Availability]] + [[CAP теорема#Partition tolerance|Partition tolerance]] систем

## BASE
Противопоставляется [[Транзакции#ACID]] 

* Basically Available
* Soft state
* Eventual consistency

## Конфликты

(Ещё см. [[Multi-leader конфликты]])

Поскольку данные на разных узлах необязательно [[CAP теорема#Consistency|согласованы]], могут возникать конфликты данных, их надо как-то решать

Два путя:
* **Amazon Dynamo** - отслеживаем версии, отдаём объединение конфликтов на откуп приложения
	* [[Multi-leader конфликты#Векторные версии]]
* **CRDT** (Conflict-free/Convergent/Commutative Replicated Data Types)
	* Такие типы данных, на которых можно детерминированно разрешать конфликты в реплицированных системах
	* [[CRDT]]


## Графовые СУБД и проблемы симметричных отношений

Допустим, мы храним какой-то граф в [[Sharding|шардированной]] БД. Шардируем по рёбрам. Храним данные об исходящих рёбрах там же, где информацию о вершине.

![[Pasted image 20220425184601.png]]

* Иногда ребро $A \rightarrow B$ без обратного ребра невозможен
	* Когда они описывают симметричное отношение (например, "быть друзьями")
* Когда A и B заключают дружбу, необходимо A добавить в список рёбер, исходящих из B
	* И наоборот
	* И сделать это транзакционно ([[Транзакции#Двухфазный коммит 2PC]] это долго, дорого, мы не хочем)
	* Но что, если A и B на разных узлах?

### Решение

* Запустим фоновый процесс, который будет искать сломанные рёбра и исправлять
* Добавим ребро $A \rightarrow B$ на узел, где лежит A
	* Пометим как *сломанное*
* #todo

## Мысли

* Eventual Consistency - не одна модель корректности, а целый класс моделей
	* Объединяет их одно: в отсутсвтие записей все живые узлы рано или поздно придут в какое-то единое состояние
* Некоторые EC-алгоритмы предполагают, что любая подтверждённая запись не может потеряться
	* Но при этом мы не можем читать старые значения
	* Асинхронаая репликация без смены лидера
	* [[Multi-Leader репликация#RSM чтение без кворума]]
* Другие EC-алгоритмы предполагают, что даже подтверждённая запись может исчезнуть
	* См. LWW-алогритмы ([[Multi-leader конфликты#На все конфликты Last Write Wins]])