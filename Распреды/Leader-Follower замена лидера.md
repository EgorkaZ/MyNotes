# Замена лидера

## Синхронная репликация
* Если лидер упал - можно заменить его почти любой из реплик
	* Так как любая реплика содержит актуальные данные
	* Этот процесс называется Failover
* В системе ни в какой момент не должно быть двух лидеров
* Сначала нужно добить старого лидера
	* Можно изолировать его на уровне сети, чтобы он не получал и не отправлял сообщения вообще
	* Можно добить молотком
* После этого включаем нового лидера

### Незавершённая операция
* Если лидер успел отреплицировать последнюю запись хотя бы на один узел => нужно реплицировать на все узлы
	![[Pasted image 20220418185822.png]]
* Если не отреплицировал никуда, можно забыть

## Асинхронная репликация
* Если недоступна реплика, система всё равно может обрабатывать любые запросы
* Если лидер упал, мы не можем произвести замену без потерь
	* Т.к. на любой реплике потенциально нет всего префикса
* Можем ждать, пока лидер поднимется
	* До этого не можем принимать запросы на запись
* А можем произвести замену с минимальной потерей

### Failover
* Выберем реплику с самым длинным журналом
	* Помним, что лидер должен быть только один
* Нарушена Durability
	* Лидер сказал, что транзакция успешна, но данные потеряны

### Объединение логов
* У нас воскрес старый лидер
* В суффиксе его логов есть данные, которых нет у нового лидера
* В суффиксе нового есть данные, которых нет у старого
![[Pasted image 20220418190304.png]]

#### Конфликты
* Часть суффикса может быть применена из старого без проблем
* Некоторые могут конфликтовать
* Самый простой способ резолва - забыть старый
* Иногда записи могут коммутировать
![[Pasted image 20220418190433.png]]

Вообще, всё зависит от вашей системы данных, думайте внимательно
