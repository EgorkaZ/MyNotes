# CRDT

Типы данных, конфликты в изменениях на которых можно детерминированно разрешать в распределённых системах

Оперируем **состоянием** системы
* **Операция** в системе задаётся состоянием, в которое придёт система при применении этой операции к начальному состоянию
* $s_0$ - начальное состояние
* $x$ - состояние применения операции $x$ к $s_0$

## Merge

Операция **объединения** после нескольких операций

* $x$ - состояние после применения операции $x$
* $y$ - состояние после применения операции $y$
* $x \sqcup y$ - состояние после применения $x$ к $y$

### Свойства

Операции должны формировать [[Semilattice|полурешётку]]

* Коммутативность - мы не имеем порядка, в котором до нас доходят операции, будет [[Консенсус]] о том, как мы будем применять их
* Идемподентность - мы не знаем, сколько раз до нас дойдёт та или иная информация
* Ассоциативность - хотим объединять операции в любом порядке

## Через операции

#todo

## Через состояние

* **Операция**: добавить $x$ к состоянию счётчика
* **Состояние**
	* **Физическое состояние**: вектор размером в число узлов
		* Каждый узел увеличивает только свою компоненту
	* **Логическое состояние**: сумма элементов вектора
* **Merge**: покомпонентный $\max$
	* Счётчик только растёт!
	* Коммутативно и идемподентно

Рассылаем состояние через [[Gossip]].

Проблемы? Плохо масштабируется: нужен вектор размера $O(N)$

## $\delta$-CRDT

Как и [[CRDT#Через состояние]] на основе сосотояний, но пересылаем только отличие (delta) от базового

### Пример

Если узел $i$ увеличил счётчик, пересылаем не весь вектор, а только мапу $\{i \rightarrow x_i\}$
* **Merge**: объединение мап и покомпонентный $\max$

### Знай соседей

Каждому соседу в gossip надо посылать только дельту по сравнению с предыдущим посланным ему значением, то есть только значения поменявшихся ключей в карте

### Итого

В стабильной системе операция вызывает распространение сообщения размером $O(1)$

### Другие CRDT

#### Счётчик вверх и вниз

Два счётчика: увеличение и уменьшение

#### Множество

Шлём и объединяем множества (или дельты по сравнению с предыдущим состоянием)

Если хотим удалять:
* Два множества: добавленных и удалённых элементов
* *Проблема*: множество удалённых элементов растёт вечно
	* Экспирация удалённых элементов со временем

#### Мапы

См. [[#Другие CRDT#Растущее множество]]

#### Одновременно редактируемые документы

Сльожно. Много компромиссов

Люди очень много бились и пытались. В итоге выяснили, что операция merge'а оказывается слишком неинтуитивной для пользователей. Так что на деле всё делают централизованно)