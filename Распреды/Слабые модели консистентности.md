# Слабые модели консистентности
* Не хотим запрещать все нарушения [[Happens before]]
	* Иначе будет слишком низкая доступность
* Хотим запретить некоторые, которые могут плохо повлиять на пользовательский опыт
	* Придумаем, какие исполнения мы хотим запретить
	* И алгоритмы, которые помогут нам избегать таких исполнений

## Вещи, которые хотим иметь
### Чтение собственных записей

#### Чтение из лидера

* Полезно, если клиент пишет мало, но читает много
	* Сайты объявлений
	* Страницы в соцсетях
* За своими записями идём на лидера
* За остальными - на фолловеров

#### Запоминание номера записи

* Помним номер самой свежей своей записи
* Игнорим репликации, которые имеют слишком тухлые записи
![[Pasted image 20220418181313.png]]

#### Монотонное чтение

То же, что [[#Запоминание номера записи]], но теперь помним последний номер из любого запроса

#### Чтение из одной реплики
* Выберем реплику, к которой ходим, ходим только в неё

Когда меняем число реплик в датацентре, часть клиентов должна будет начать читать с новой реплики
* Тут техники [[Sharding]]

### Чтение согласованнгоо префикса

Нужно, если есть шардирование

Пример: тред с обсудением в социальной сети, реплай в переписке

![[Pasted image 20220418182518.png]]

#### Настройка системы шардирования
* Если сущность Y может зависеть от сущности X - будем хранить их в одной секции
* Будем хранить все сообщения из одного чата в одной и той же секции
	* Секционирование по hash(chat_id)
* Сделать так можно не всегда

#### Специфичные для приложения методы
* Просто не будем отображать комментарий, если не можем отобразить исходное сообщение
	* Если оно ещё не отреплицировалось на реплику, с которой читаем
* Как получим - сможем отобразить

#### Версионирование записей
* Каждая запись в логе хранит N чисел
	* Одно из них - порядковый номер записи в логе текущего шарда
	* Остальное - порядковые номера записей в логах других шардов, от которых зависит наша запись 
	* Хотим читать записи "не позже" с этих шардов
![[Pasted image 20220418183114.png]]
#todo переписать алгоритм
![[Pasted image 20220418183256.png]]

Похоже на поиск [[Глобальное состояние#Согласованный срез|согласованного среза]]

##### Проблемы
* В более поздней записи может случиться удаление сущности
	* Можно никогда не удалять записи
		* Помечать как удалённые
	* Можно использовать персистентные структуры данных

* Хотим отобразить сообщение M с ответом R
	* Подойдут ли записи \[6, 5, 1\]?
		* Нет, потому что существует ответ T на неизвестную запись N
		* Для отображения M и R они вообще не нужны
	* Можем хранить зависимости в явной форме
		* Т.е. не на записи в логах, а сущности
![[Pasted image 20220418183717.png]]