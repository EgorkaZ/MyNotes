 # Конвенции вызова

Есть 2 стула:
* нормальная
* виндовая - fastcall64

## fastcall 64

### Параметры

Параметры передаются в регистрах
`rcx`, `rdx`, `r8`, `r9`

или

`xmm0..3`, по одной чиселке на регистр

```
foo(int, float, float*, double)
    ecx   xmm1    r8      xmm3
```

Остальные аргументы идут на стеке

Возвращаем значение в `rax`/`xmm0`

### Что сохранять

`rbx`, `rsi`, `rdi`, `rbp`,`r12`-`r15`, `xmm6`-`xmm15`

### Супер фича - shadow space

До адреса возврата при вызове функции даётся 32 байта памяти между стек поинтером и 4-м аргументом

### А ещё

`rsp` должен быть кратен 16-ти

## Unix64

Предложена амд-шниками, вообще говоря, никак не называется

### Параметры
`rdi`, `rsi`, `rdx`, `rcx`, `r8`, `r9` (`rcx` меняется на `r10`, если это `syscall`, потому что в `rcx` номер `syscall`'а')
и `xmm0..7`

```
foo(int, float, float*, double)
    edi   xmm0   rsi      xmm1
```

Перед вызовом var arg функций нужно указать количество используемых `xmm` регистров в `rax`

Возвращаем в `rdx` + `rax`, либо в `xmm0` + `xmm1`

### Что сохранять

`rbx`, `rbp`, `r12`-`r15`

### Супер фича - red zone

Обещают сохранность данных в зоне `[rsp - 128]..[rsp-8]`

### А ещё

`rsp` тоже кратен 16-ти