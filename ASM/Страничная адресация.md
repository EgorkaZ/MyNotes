# Страничная адресация

Есть адрес вида сегмент:смещение, который превращается в линейный адрес. Без страничной адресации это и есть физический адрес. Но в страничной есть ещё один уровень иронии.

Адресное пространство нарезано по 4 КБ. Для каждого есть структурка, которая описывает этот кусок. В ней, например, говорится, смаплен ли кусочек куда-то. Существует некоторый маппинг страниц в железную память (несколько могут маппиться в одну память, кста)

## 32-битный мир

Есть табичка, указатель на которую лежит в регистре `CR3`, занимает страницу

Первые 10 бит адреса - индекс в табличке `CR3`, где каждый элемент - указатель на табличку 2-го уровня

Вторые 10 бит адреса - индекс в табличке второго уровня (она тоже занимает 1 страницу, кста)

Последние 12 бит - смещение в страничке, которую мы нашли

Таблички меняются при смене процессов. Системы обычно оставляют вторую её половину для kernel адресов, которые не меняются при переключении процесса

#NB у нас таблички лежат в своих страничках. Адрес странички у нас всё равно кратен 2^12, потому 12 бит мы можем заюзать под свои флажки

* Есть битик про то, доступна ли страничка всем или только 0-му кольцу
* Есть битик, а валидна ли вообще страница
* битик, а это R или RW
* битик "грязная страница" - после первой записи в страницу
	* выставляется в 0 до swap'ования (на самом деле пейджинга, а swap'инг это про выгрузку и остановку всего процесса), если остаётся 0 после того, как мы её подгрузили, и решили, что надо бы его пейджнуть снова, можно и не переписывать
* битик, выставляемый после первого обращения


*А потом пошли расширения...*

### Huge pages
Адрес в табличке 1-го уровня может указывать не на табличку 2-го уровня, а сразу на страничку в 1МБ

Для них отдельный кеш, и вообще всё побыстрей

### PAE

На дворе pentium pro. Примерно так всё выглядит для современных [[x86]]

Теперь мы можем иметь 36 бит для адреса оперативки

КАК БЛЯТЬ?

Теперь у нас вхождения в табличках по 8Байт. Табличек теперь 3

Первые 2 бита адресуются в табличке 1-го уровня. Дальше 2 адреса по 9 бит. За счёт того, что структурки стали больше, мы можем выделить 36 бит под физический адрес.

Можно принять это через то, что наши 4 байта могли быть указателем на сколь угодно большую структурку, где уже был бы хоть 8-мибайтный указатель на физический адрес

### 64-битный мир

В мире [[x64]] всё то же, накинули слоёв иронии

Старшие 16 бит должны быть canonical: такими же, как старший из оставшихся 48-бит (который про доступ, вродь)

В 8-мибайтных структурках появился битик `NX` - no execution

