# Domain Name System

Превращаем человекочитаемое имя в [[IP address]]

* label $\le$ 63 chars
	* `'.'` разделяет лейблы
* name $\le$ 254 chars
* `[a-zA-Z0-9-]`
	* Имена регистронезависимые


#rfc 1035 1101 1183 1348 1876 .........

## IDN
(Internationalized Domain Name)

Используем весь Unicode, но поскольку протокол изначально такое не поддерживает, как-то по-странному их кодируем...

*итмо.рф -> xn--h1aigo.xn--p1ai*


Но так можно подменять похожие буквы разных алфавитов для фишинга
* Можно запрещать наборы символов в доменах:
	* В `.рф` нельзя латиницу
	* В `.ru` нельзя кириллицу
	* В `.com` можно всё
* Порядочные браузеры смотрят на такие вещи
* Хороших решений всё ещё нет

## Где хранить

* В файлике
	* `/etc/hosts`
	* `C:\system32`... на винде
	* Можно добавлять несколько имён на один IP
	* Плохо масштабируется
	* Хотим хранить больше информации...

### Resource records

| Обозначение | Содержание |
| - | - |
| A | [[IP address#IPv4]] |
| AAAA | [[IP address#IPv6]] |
| CNAME | Alias to another name |
| PTR | Alias to another name, don't resolve further |
| TXT | Arbitrary text |
| NXDOMAIN | Domain doesn't exist |
| MX | Mail server |
| NS | Zone on another server |
|  | У меня нет информации, но знаю, у кого есть |
| SOA | Start of authority |

### Распределённый DNS

Если хотим хорошую масштабируемость, стоит всё [[Sharding|пошардировать]] ( #todo как будет запись про иерархическое шардирование, перекинуть туда )

![[Pasted image 20220427170520.png]]

* Вводим понятие *зоны*: множество данных, соответствующее одному домену
* В соответствии с адресом, отправляем на сервер, который знает про конкретную *зону*
* #todo: это было на распредах

#### Root DNS servers

* Есть 13 известных IP-шников
	* Вообще, серверов больше, они распределены географически, но IP-шников на них 13
* [Ссылка](https://www.iana.org/domains/root/servers)
* Могут ответить про *зону* 1-го уровня (топ-левел домены)
	* Первыми были 7 домнов, говорящих о том, какой род организации:
		* .com, .org, .net, .int, .edu, .gov, .mil
	* Двухбуквенные домены - домены стран (и существуют по правилам этих стран)
		* .ru, .us, .io, .me, .tv, ...
	* Домены по [[#IDN]]
		* .рф, .укр, ...
	* Всякие разные доменные имена, на которых IANA поднимает нормально денег
		* .footbal, .bar, .flowers, .google, .moscow, .москва
		* [Ссылка](https://www.iana.org/domains/root/db)

### Recursive resolver

По дефолту, требуется очень много походов с резолвами доменов первого уровня (для всяких промежуточных серверов). Всё грустно даже с учётом кеширования

Конфиг лежит в `/etc/resolv.conf`

Например:
* 1.1.1.1
* 8.8.8.8
* 8.8.4.4

Занимаются тем же, чем ваш провайдер, но если они достаточно большие, то большая часть ваших запросов уже закеширована

## Всякое

### Reverse DNS

Есть домен .arpa, если к нему сделать правильный запрос, он может выдать доменное имя, соответствующее данному адресу

## Protocol

![[Pasted image 20220427175443.png]]

* Answer: ответы не Authority сервера
	* Например, то, что выдаст [[#Recursive resolver]]
* Authority: данные от себя, в которых мы уверены точно

### Transport 

* Исторически [[UDP]] port 53
	* До 512-ти байт
* [[TCP]] port 53
* DNS over [[TLS]] (DoT)
	* #rfc 7858
* DNS over [[HTTPS]]
	* #rfc 8484
	* Из плюсов: сложно отличить от обычного открытия веб страницы

## EDNS(0)
(Extended DNS v.0)

Если указали во флагах OPT, то можно
* Принимать больше 512-ти байт по [[UDP]]
* Можно слать [[IP address]] клиента
	* Не обязательно себя. Полезно для [[#Recursive resolver]]'ов
	* Так можно правильней выдавать локальный адрес

#rfc 6891

## Атаки

### DNS Cache poisoning

Попытаться заслать свой вариант ответа на DNS запрос
* Но клиент примет только ответ с тем же полем identification (см [[#Protocol]])
	* Вообще, там всего два байта, можно попытаться заслать много ответов
	* Можно подслушать
		* Если вы можете подслушать, у вас и так всё хорошо
* Сервер обязан ответить с той же капитализацией, которая была в запросе (адреса case-insensitive, помним)
	* Нарандомив капитализацию, добавляем энтропию к identification полю
	* [[HTTPS]] сертификаты выдаются на конкретную капитализацию